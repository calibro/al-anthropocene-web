"use strict";angular.module("anthropoceneWebApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","btford.socket-io","com.2fdevs.videogular","angular-loading-bar","ngIdle"]).config(["$routeProvider","IdleProvider",function(a,b){a.when("/network",{templateUrl:"views/network.html",controller:"NetworkCtrl",controllerAs:"network",resolve:{networkData:["apiService",function(a){return a.getNetwork()}]}}).when("/player",{templateUrl:"views/player.html",controller:"PlayerCtrl",controllerAs:"player"}).otherwise({redirectTo:"/network"}),b.idle(300)}]).config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),angular.module("anthropoceneWebApp").factory("playlistService",["$q","$http",function(a,b){var c=[];return{setPlaylist:function(a){c=a},getPlaylist:function(){return c}}}]),angular.module("anthropoceneWebApp").factory("socket",["socketFactory",function(a){var b=io.connect("https://floating-wave-21737.herokuapp.com/"),c=a({ioSocket:b});return c}]),angular.module("anthropoceneWebApp").run(["socket","$location","playlistService",function(a,b,c){a.on("guiView",function(a){console.log("changed view to ",a),"create"==a.view&&b.path("/network").search({room:a.room})}),a.on("playlist",function(a){c.setPlaylist(a.chunks),b.path("/player").search({room:a.room})})}]),angular.module("anthropoceneWebApp").factory("apiService",["$q","$http",function(a,b){var c="http://dicto-ao.herokuapp.com/api/";return{getFile:function(c){var d=a.defer();return b.get(c).success(function(a){d.resolve(a)}).error(function(){d.reject("An error occured while fetching file")}),d.promise},getNetwork:function(d){var e="network",f=a.defer();return b({method:"GET",url:c+e,params:d}).success(function(a){f.resolve(a)}).error(function(){f.reject("An error occured while fetching file")}),f.promise}}}]),angular.module("anthropoceneWebApp").controller("NetworkCtrl",["$scope","networkData","socket","$window","$timeout","$routeParams",function(a,b,c,d,e,f){var g=f.room;c.emit("room",g),a.netData=b,a.nodeSelected=[],c.on("entities",function(b){a.nodeSelected=b.entities}),c.on("resetCreate",function(a){d.location.reload()}),c.on("reset",function(a){d.location.reload()}),e(function(){c.emit("resetCreate",{room:g})},4e5)}]),angular.module("anthropoceneWebApp").controller("PlayerCtrl",["$scope","$sce","mediaService","playlistService","socket","$interval","$timeout","$location","$routeParams",function(a,b,c,d,e,f,g,h,i){var j=i.room;a.controller=this,a.controller.state=null,a.controller.API=null,a.controller.currentVideo=0,a.hide=!1,a.chunks=d.getPlaylist();a.controller.onPlayerReady=function(b){a.controller.API=b,a.controller.API.setVolume(1)},a.controller.config={theme:{url:"http://www.videogular.com/styles/themes/default/latest/videogular.css"},preload:"none",width:640,height:480,autoPlay:"false"},a.controller.setVideo=function(d,f){a.hide=!1,a.controller.currentVideo=d,a.chunk=a.chunks[a.controller.currentVideo],f&&e.emit("playChunk",{chunk:a.chunk.id,room:j}),a.controller.config.sources=[{src:b.trustAsResourceUrl(c.getVideoUrl(a.chunk.videoId)),type:"video/mp4"}],a.controller.API.changeSource(a.controller.config.sources)},a.$watchCollection("chunks",function(b,c){console.log(b),b.length&&a.controller.setVideo(0,!1)}),a.playVideo=function(b){a.controller.API.seekTime(parseInt(a.chunk.start)),console.log(a.controller.API.currentTime/1e3,"timing after load"),g(function(){a.hide=!0},3e3),g(function(){a.controller.checkTime()},100)},a.controller.checkTime=function(){a.controller.API.currentTime/1e3>=a.chunk.end?(a.controller.API.stop(),a.controller.currentVideo<a.chunks.length-1?a.controller.setVideo(a.controller.currentVideo+1,!0):(console.log("finished!"),g(e.emit("backToCreate",{room:j})))):"/player"==h.path()&&(e.emit("playTime",{time:(a.controller.API.currentTime/1e3-a.chunk.start)/a.chunk.duration*100,video:a.chunk.id,room:j}),g(a.controller.checkTime,500))},e.on("playStatus",function(b){"pause"==b?(a.hide=!1,a.controller.API.pause()):"play"==b&&(g(function(){a.hide=!0},5e3),a.controller.API.play())}),e.on("playChunk",function(b){var c=a.chunks.findIndex(function(a){return a.id==b});a.controller.setVideo(c,!1)})}]),angular.module("anthropoceneWebApp").directive("network",["apiService",function(a){return{restrict:"A",link:function(b,c,d){function e(c){var d=c.length?{nodes:JSON.stringify(c)}:null;a.getNetwork(d).then(function(a){y.each(function(a){b.nodeSelected.indexOf(a.id)>-1?a.fixed=!0:a.fixed=!1}),a.links.forEach(function(b){var c=a.nodes[b.source].id+"_"+a.nodes[b.target].id,d=t.filter(function(a,b){var d=a.source.id+"_"+a.target.id;return c===d?!0:!1});if(d.length>0);else{var e=h("id",a.nodes[b.source].id),f=h("id",a.nodes[b.target].id);g(e,f,b.value)}});for(var c=a.nodes.map(function(a){return a.id}),d=s.length-1;d>=0;d--){var e=a.nodes.filter(function(a){return a.id===s[d].id});if(0==e.length)for(var f=s[d].id,j=0;j<t.length;)t[j].source.id==f||t[j].target.id==f?t.splice(j,1):j++}y.filter(function(a){return a.fixed}).transition().duration(2e3).ease("elastic").attr("fill","white").attr("r",function(a){return v(a.value)}).attr("stroke-opacity",function(a){return x(a.value)}).tween("x",function(a){var c=d3.interpolate(a.x,p[b.nodeSelected.length-1][b.nodeSelected.indexOf(a.id)].x);return function(b){a.x=c(b),a.px=c(b)}}).tween("y",function(a){var c=d3.interpolate(a.y,p[b.nodeSelected.length-1][b.nodeSelected.indexOf(a.id)].y);return function(b){a.y=c(b),a.py=c(b)}}),y.filter(function(a){return!a.fixed}).transition().duration(2e3).attr("fill","black").attr("fill-opacity",1).attr("stroke-opacity",function(a){return x(a.value)}).attr("r",function(a){return v(a.value)}).filter(function(a){return c.indexOf(a.id)<0?!0:!1}).attr("r",1).attr("fill","white").attr("fill-opacity",1).attr("stroke-opacity",0),z.transition().duration(2e3).attr("fill-opacity",1).filter(function(a){return c.indexOf(a.id)<0?!0:!1}).attr("fill-opacity",0),d3.selectAll(".singleTxts").text(function(a){return b.nodeSelected.indexOf(a.id)>-1||a.value>4?a.name.split(",")[0]:void 0}).call(i,120)},function(a){console.log("error loading data")})}function f(a){s.push(a)}function g(a,b,c){var d=a,e=b;void 0!==d&&void 0!==e&&t.push({source:d,target:e,value:c})}function h(a,b){for(var c=0;c<s.length;c++)if(s[c][a]===b)return s[c]}function i(a,b){a.each(function(){var a=d3.select(this),c=a.text().split(/\s+/).reverse();if(!(c.length<2))for(var d,e=[],f=0,g=1,h=a.attr("y"),i=parseFloat(a.attr("dy")),j=a.text(null).append("tspan").attr("x",0).attr("y",h).attr("dy",+i+"em");d=c.pop();)if(e.push(d),j.text(e.join(" ")),j.node().getComputedTextLength()>b)return e.pop(),j.text(e.join(" ")).attr("dy","0em"),e=[d],2>f?(j=a.append("tspan").attr("x",0).attr("y",h).attr("dy",g+i+"em").text(d+"..."),void++f):2==f?(j=a.append("tspan").attr("x",0).attr("y",h).attr("dy",g+i+"em").text(d),void++f):void 0})}function j(a){var b=2*a.bb+20,c=a.x-b,d=a.x+b,e=a.y-b,f=a.y+b;return function(b,g,h,i,j){if(b.point&&b.point!==a){var k=a.x-b.point.x,l=a.y-b.point.y,m=Math.sqrt(k*k+l*l),n=a.bb+b.point.bb+20;n>m&&(m=(m-n)/m*.5,a.x-=k*=m,a.y-=l*=m,b.point.x+=k,b.point.y+=l)}return g>d||c>i||h>f||e>j}}var k=c.width(),l=c.height(),m=d3.select(c[0]).append("svg").attr("width",k).attr("height",l),n=(m.append("g").attr("class","links"),m.append("g").attr("class","nodes")),o=m.append("g").attr("class","txt"),p=[[{x:k/2,y:l/2}],[{x:k/3,y:l/2},{x:k/3*2,y:l/2}],[{x:k/3,y:l/3},{x:k/3*2,y:l/3},{x:k/2,y:l/3*2}]],q=m.append("defs").append("filter").attr("id","outlineFilter");q.append("feMorphology").attr("in","SourceAlpha").attr("operator","dilate").attr("radius",5).attr("result","morphed"),q.append("feColorMatrix").attr("in","morphed").attr("type","matrix").attr("values","1 0 0 0 -1, 0 1 0 0 -1,  0 0 1 0 -1,0 0 0 1 0").attr("result","recolored");var r=q.append("feMerge");r.append("feMergeNode").attr("in","recolored"),r.append("feMergeNode").attr("in","SourceGraphic");var s=[],t=[],u=d3.layout.force().gravity(.25).friction(.5).nodes(s).links(t).linkDistance(function(a){return w(a.value)}).linkStrength(.5).charge(-2500).chargeDistance(2500).size([k,l]),v=d3.scale.log().range([10,50]),w=d3.scale.linear().range([400,200]),x=d3.scale.log().range([.3,1]);v.domain(d3.extent(b.netData.nodes,function(a){return a.value})),w.domain(d3.extent(b.netData.links,function(a){return a.value})),x.domain(d3.extent(b.netData.nodes,function(a){return a.value})),b.netData.nodes.forEach(function(a){var b=h("id",a.id);void 0===b?f(a):b.value=a.value}),b.netData.links.forEach(function(a){g(b.netData.nodes[a.source],b.netData.nodes[a.target],a.value)});var y=n.selectAll(".node").data(u.nodes(),function(a){return a.id}),z=o.selectAll(".txts").data(u.nodes(),function(a){return a.name}),A=z.enter().append("g").attr("class","txts").attr("fill-opacity",0);A.append("text").attr("dx",0).attr("dy",".3em").attr("class","singleTxts").attr("font-size","10px").attr("text-anchor","middle").attr("fill","white").attr("pointer-events","none").attr("filter","url(#outlineFilter)").filter(function(a){return a.value>4}).text(function(a){return a.name.split(",")[0]}).call(i,120),z.each(function(a){var b=this.getBBox();0==a.bb?a.bb=v(a.value):b.width/2>v(a.value)?a.bb=b.width/2:a.bb=v(a.value)});y.enter().append("circle").attr("fill","black").attr("fill-opacity",0).attr("stroke-width",2).attr("stroke","white").attr("stroke-opacity",0).attr("class","node").attr("r",function(a){return v(a.value)});y.attr("fill-opacity",1).transition().duration(2e3).delay(function(a,b){return b/u.nodes().length*2e3}).attr("stroke-opacity",function(a){return x(a.value)}),z.transition().duration(4e3).delay(function(a,b){return b/u.nodes().length*4e3}).attr("fill-opacity",1),u.start(),u.on("tick",function(){for(var a=d3.geom.quadtree(u.nodes()),c=0,d=u.nodes().length;++c<d;)a.visit(j(u.nodes()[c]));b.nodeSelected.length?(y.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),z.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})):(d3.selectAll(".node").attr("cx",function(a){return a.x=Math.max(2*v(a.value),Math.min(k-2*v(a.value),a.x)),a.x}).attr("cy",function(a){return a.y=Math.max(2*v(a.value),Math.min(l-2*v(a.value),a.y)),a.y}),d3.selectAll(".txts").attr("transform",function(a){return a.x=Math.max(2*v(a.value),Math.min(k-2*v(a.value),a.x)),a.y=Math.max(2*v(a.value),Math.min(l-2*v(a.value),a.y)),"translate("+a.x+","+a.y+")"}))}),u.on("end",function(a){u.alpha(.0075)}),b.$watch("nodeSelected",function(a,b){a!=b&&e(a)},!0)}}}]),angular.module("anthropoceneWebApp").factory("mediaService",["$q","$http",function(a,b){var c="videos/",d={"hkw-video-1":"kzzfqp0pvk68j6u","hkw-video-2":"po7yfqpownqp0ve","hkw-video-3":"ne7pvpq29anig20","hkw-video-4":"o7ls2l7ty2z0nd3","hkw-video-5":"1516o1w7qbf1onr"};return{getVideoUrlOLD:function(a){return c+a+".mp4"},getVideoUrl:function(a){var b="https://dl.dropbox.com/s/"+d[a]+"/"+a+".mp4?dl=1";return b},getThumbUrl:function(a,b){var d="antropovids/thumbs/output/";b=b.replace(a+"-","");var e=b.split("-")[0];return c+d+a+"/chunk-"+(parseInt(e)+1)+"-sh-2.png"}}}]),angular.module("anthropoceneWebApp").run(["$templateCache",function(a){a.put("views/network.html",'<div network class="network"></div>'),a.put("views/player.html",'<div ng-class="{\'title-hidden\':hide}" class="player-title"> <div ng-repeat="s in chunk.speakers"> <span>{{s.name.split(",")[0]}}</span> <div class="player-sub">{{s.name.split(",",2)[1]}}</div> </div> </div> <div ng-class="{\'tags-overlay\':hide}" class="player-tags"> <span ng-repeat="t in chunk.themes">{{t.name}}</span> </div> <videogular vg-width="controller.config.width" vg-height="controller.config.height" vg-change-source="playVideo($source)" vg-auto-play="true" vg-player-ready="controller.onPlayerReady($API)" vg-complete="controller.onCompleteVideo()" vg-theme="controller.config.theme.url"> <!--<div class="prev-shade">--> <vg-media vg-src="controller.config.sources"> </vg-media> <!--<vg-overlay-play></vg-overlay-play>--> </videogular>')}]);